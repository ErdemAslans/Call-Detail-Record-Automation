# =============================================================================
# CDR API - GitHub Actions CI/CD Pipeline
# =============================================================================
# Bu workflow ÅŸunlarÄ± yapar:
# 1. Her push'ta kodu derler (build) - GitHub'Ä±n sunucusunda
# 2. Testleri Ã§alÄ±ÅŸtÄ±rÄ±r (varsa) - GitHub'Ä±n sunucusunda
# 3. main branch'e push'ta production'a deploy eder - SELF-HOSTED RUNNER ile
#
# âš ï¸ Ã–NEMLÄ°: Deploy iÃ§in sunucuya Self-Hosted Runner kurulmalÄ±!
# Kurulum: https://docs.github.com/en/actions/hosting-your-own-runners
# =============================================================================

name: ğŸš€ CDR API CI/CD

on:
  push:
    branches:
      - main
      - master

  pull_request:
    branches:
      - main
      - master

  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'Cdr.Api.csproj'

jobs:
  # =========================================================================
  # JOB 1: Build & Test (GitHub-hosted runner - Ã¼cretsiz)
  # =========================================================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest  # GitHub'Ä±n sunucusunda Ã§alÄ±ÅŸÄ±r

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: ğŸ”¨ Build
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

      - name: ğŸ§ª Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal
        continue-on-error: true

  # =========================================================================
  # JOB 2: Deploy to Production (Self-hosted runner - sunucuda Ã§alÄ±ÅŸÄ±r)
  # =========================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    needs: build

    # âš ï¸ SELF-HOSTED RUNNER - Sunucuda kurulu olmalÄ±!
    # 'windows' = iÅŸletim sistemi, 'production' = label
    runs-on: [self-hosted, windows, production]

    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    environment:
      name: production
      url: https://doascdrapi.fw.dohas.com.tr

    steps:
      # Runner zaten sunucuda, git pull yeterli
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Create backup
        shell: cmd
        run: |
          echo Creating backup...
          if not exist "C:\Backups\Cdr.Api" mkdir "C:\Backups\Cdr.Api"
          xcopy /E /I /Y "C:\Projects\Cdr.Api" "C:\Backups\Cdr.Api\backup_%date:~-4,4%%date:~-7,2%%date:~-10,2%"
        continue-on-error: true

      - name: ğŸ“‹ Backup production config (BEFORE git reset)
        shell: powershell
        run: |
          $configPath = "C:\Projects\Cdr.Api\appsettings.json"
          if (Test-Path $configPath) {
            Copy-Item $configPath "$configPath.production.bak" -Force
            Write-Host "Production appsettings.json backed up BEFORE git reset"
          } else {
            Write-Host "No existing appsettings.json to backup"
          }

      - name: ğŸ“¥ Update production code
        shell: cmd
        working-directory: C:\Projects\Cdr.Api
        run: |
          echo Pulling latest code...
          git fetch origin
          git reset --hard origin/main

      - name: ğŸ”¨ Build & Publish
        shell: cmd
        working-directory: C:\Projects\Cdr.Api
        run: |
          echo Building...
          dotnet publish -c Release -o .

      - name: ğŸ“‹ Restore production config
        shell: powershell
        run: |
          $bakPath = "C:\Projects\Cdr.Api\appsettings.json.production.bak"
          $configPath = "C:\Projects\Cdr.Api\appsettings.json"
          if (Test-Path $bakPath) {
            Copy-Item $bakPath $configPath -Force
            Remove-Item $bakPath -Force
            Write-Host "âœ… Production appsettings.json restored"
          }

      - name: ğŸ”„ Restart IIS
        shell: cmd
        run: |
          echo Restarting IIS...
          iisreset /restart

      - name: âœ… Deployment complete
        run: echo "Deployment completed successfully!"

  # =========================================================================
  # JOB 3: Verify (Self-hosted runner)
  # =========================================================================
  verify:
    name: âœ… Verify Deployment
    needs: deploy
    runs-on: [self-hosted, windows, production]

    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: â³ Wait for IIS to start
        shell: powershell
        run: Start-Sleep -Seconds 10

      - name: ğŸ¥ Health check
        shell: powershell
        run: |
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:5000/health" -UseBasicParsing -TimeoutSec 10
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ… Health check passed!"
            }
          } catch {
            Write-Host "âš ï¸ Health check skipped (endpoint may not exist)"
          }
        continue-on-error: true
